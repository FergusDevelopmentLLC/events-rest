<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  <meta charset="utf-8">
  <title>Events</title>
  <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jQuery-JSONP/2.4.0/jquery.jsonp.js" type="text/javascript"></script>
  <script src="https://momentjs.com/downloads/moment.js" type="text/javascript"></script>
  <style>
    #map { height: 100%; }

    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <script>

    let prev_infowindow = false

    const getEvents = async (bounds) => {

      // let startDate
      // let endDate
      // let url

      // var urlParams = new URLSearchParams(window.location.search)
      // let entries = urlParams.entries()

      // if(entries) {
      //   console.log(entries)
      //   for(pair of entries) { 
      //     if(pair[0] == 'startDate' || pair[0] == 'endDate') {
      //       console.log(pair[0], pair[1]); 
      //       if(pair[0] == 'startDate') {
      //         startDate = pair[1]
      //       }
      //       if(pair[0] == 'endDate') {
      //         endDate = pair[1]
      //       }
      //     }
      //   }
      //   url = `http://104.236.16.91:8680/getEvents/${bounds.da.g}/${bounds.ha.g}/${bounds.da.h}/${bounds.ha.h}/${startDate}/${endDate}`
      // }
      // else {
      //   url = `http://104.236.16.91:8680/getEvents/${bounds.da.g}/${bounds.ha.g}/${bounds.da.h}/${bounds.ha.h}/2019-01-01/2019-12-31`
      // }
      
      let url = new URL(window.location.href)
      
      let targetUrl
      if (url.searchParams.get('startDate') && url.searchParams.get('endDate')) {
        let sDate = url.searchParams.get('startDate')
        let eDate = url.searchParams.get('endDate')
        targetUrl = `http://104.236.16.91:8680/getEvents/${bounds.da.g}/${bounds.ha.g}/${bounds.da.h}/${bounds.ha.h}/${sDate}/${eDate}`
      }
      else {
        targetUrl = `http://104.236.16.91:8680/getEvents/${bounds.da.g}/${bounds.ha.g}/${bounds.da.h}/${bounds.ha.h}/2019-01-01/2019-12-31`
      }

      let events = await $.ajax({
        url: targetUrl
      })

      return events
    }

    const getContentFrom = (event) => {
      return `<div id="content">
                <h1 id="firstHeading" class="firstHeading">McDonald's ${event.city}</h1>
                <div id="bodyContent">
                  <p><img src='${event.venue_image_url}' width='100' /></p>
                  <p>
                    <strong>Description:</strong><br/>
                    ${event.event_description}
                  </p>
                  <p>
                    <strong>Date/Time:</strong><br/>
                    ${moment(event.startDate).format("MMM DD, YYYY")}: ${moment(event.startDate).format("h:mm A")} until ${moment(event.endDate).format("h:mm A")}
                  </p>
                  <p>
                    <strong>Address:</strong><br/>
                    ${event.address}</br>
                    ${event.city}, ${event.state_province} ${event.postal_code ? event.postal_code : ""}
                  </p>
                  <p>
                    <strong>Phone:</strong><br/>
                    ${event.phone}
                  </p>
                  <p><a href='${event.event_url}'>Register for event</a></p>
                </div>
              </div>`
    }

    const plotMarkers = async (map) => {

      let events = await getEvents(map.getBounds())

      let markers = events.map((event, i) => {

        let toolTipContent = getContentFrom(event)

        let infowindow = new google.maps.InfoWindow({ content: toolTipContent })

        let marker = new google.maps.Marker({
          position: {lat: event.latitude, lng: event.longitude},
          map: map,
          title: `McDonald's ${event.city}`
        })

        marker.addListener('click', () => {
          if( prev_infowindow ) prev_infowindow.close()
          prev_infowindow = infowindow
          infowindow.open(map, marker)
        })
        return marker
      })

      let markerCluster = new MarkerClusterer(map, markers, { imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m' })
    } 

    async function initMap() {

      let map = new google.maps.Map(document.getElementById('map'), {
        zoom: 10,
        center: { lat: 39.754, lng: -105.008 },
        minZoom: 9
      })

      google.maps.event.addListener(map, 'bounds_changed', () => { 
        plotMarkers(map) 
      })

    }

  </script>

  <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBXmDsuoKrugv-302U1fRnvGz1d4Bi2HR8&callback=initMap"></script>

</body>
</html>